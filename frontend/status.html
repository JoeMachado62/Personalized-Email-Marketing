<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Sales Agent - Job Status</title>
    <link rel="stylesheet" href="../app/static/styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-title">AI Sales Agent</h1>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Upload</a>
                <a href="status.html" class="nav-link active">Status</a>
                <a href="history.html" class="nav-link">History</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="status-header-section">
            <h2>Job Status</h2>
            <div class="header-actions">
                <button class="btn btn-secondary" id="refreshBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                    </svg>
                    Refresh
                </button>
                <div class="auto-refresh-toggle">
                    <input type="checkbox" id="autoRefresh" checked>
                    <label for="autoRefresh">Auto-refresh</label>
                </div>
            </div>
        </div>

        <div class="job-search">
            <div class="search-input-container">
                <input type="text" id="jobIdInput" placeholder="Enter Job ID to track specific job">
                <button class="btn btn-primary" id="trackJobBtn">Track Job</button>
            </div>
        </div>

        <div class="current-job-section" id="currentJobSection" style="display: none;">
            <div class="job-card current-job">
                <div class="job-header">
                    <div class="job-title">
                        <h3>Current Job</h3>
                        <div class="job-id" id="currentJobId">-</div>
                    </div>
                    <div class="job-status">
                        <div class="status-badge" id="currentJobStatus">Unknown</div>
                        <div class="job-timestamp" id="currentJobTime">-</div>
                    </div>
                </div>

                <div class="progress-section">
                    <div class="progress-container">
                        <div class="progress-bar large">
                            <div class="progress-fill" id="currentProgressFill"></div>
                        </div>
                        <div class="progress-text">
                            <span class="progress-percentage" id="currentProgressPercentage">0%</span>
                            <span class="progress-details" id="currentProgressDetails">Waiting...</span>
                        </div>
                    </div>
                </div>

                <div class="job-metrics">
                    <div class="metric">
                        <div class="metric-value" id="totalRecords">-</div>
                        <div class="metric-label">Total Records</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="processedRecords">-</div>
                        <div class="metric-label">Processed</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="failedRecords">-</div>
                        <div class="metric-label">Failed</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="estimatedCompletion">-</div>
                        <div class="metric-label">ETA</div>
                    </div>
                </div>

                <div class="job-actions" id="currentJobActions">
                    <button class="btn btn-success" id="downloadCurrentBtn" style="display: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Download Results
                    </button>
                    <button class="btn btn-secondary" id="viewLogsBtn">View Logs</button>
                    <button class="btn btn-danger" id="cancelJobBtn" style="display: none;">Cancel Job</button>
                </div>

                <div class="job-logs" id="jobLogs" style="display: none;">
                    <h4>Processing Logs</h4>
                    <div class="log-container" id="logContainer">
                        <div class="log-entry">
                            <span class="log-time">Loading...</span>
                            <span class="log-message">Fetching job logs...</span>
                        </div>
                    </div>
                </div>

                <div class="error-details" id="errorDetails" style="display: none;">
                    <h4>Error Information</h4>
                    <div class="error-content" id="errorContent"></div>
                </div>
            </div>
        </div>

        <div class="recent-jobs-section">
            <h3>Recent Jobs</h3>
            <div class="jobs-grid" id="jobsGrid">
                <div class="loading-message">
                    <div class="spinner"></div>
                    <p>Loading recent jobs...</p>
                </div>
            </div>
        </div>

        <div class="system-status">
            <h3>System Status</h3>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-icon healthy" id="apiStatus"></div>
                    <div class="status-info">
                        <div class="status-title">API Service</div>
                        <div class="status-description" id="apiStatusText">Checking...</div>
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-icon healthy" id="workerStatus"></div>
                    <div class="status-info">
                        <div class="status-title">Workers</div>
                        <div class="status-description" id="workerStatusText">Checking...</div>
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-icon healthy" id="dbStatus"></div>
                    <div class="status-info">
                        <div class="status-title">Database</div>
                        <div class="status-description" id="dbStatusText">Checking...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert" id="alertMessage" style="display: none;">
            <div class="alert-content">
                <div class="alert-icon" id="alertIcon"></div>
                <div class="alert-text" id="alertText"></div>
            </div>
        </div>
    </div>

    <script>
        // Status page specific functionality
        let currentJobId = null;
        let autoRefreshEnabled = true;
        let refreshInterval = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Get job ID from URL params
            const urlParams = new URLSearchParams(window.location.search);
            const jobId = urlParams.get('job');
            
            if (jobId) {
                currentJobId = jobId;
                document.getElementById('jobIdInput').value = jobId;
                loadJobStatus(jobId);
            }

            loadRecentJobs();
            checkSystemStatus();
            startAutoRefresh();

            // Event listeners
            document.getElementById('trackJobBtn').addEventListener('click', trackSpecificJob);
            document.getElementById('refreshBtn').addEventListener('click', refreshAllData);
            document.getElementById('autoRefresh').addEventListener('change', toggleAutoRefresh);
            document.getElementById('viewLogsBtn').addEventListener('click', toggleLogs);
            document.getElementById('downloadCurrentBtn').addEventListener('click', downloadCurrentJob);
            document.getElementById('cancelJobBtn').addEventListener('click', cancelCurrentJob);

            // Handle Enter key in job ID input
            document.getElementById('jobIdInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    trackSpecificJob();
                }
            });
        });

        function trackSpecificJob() {
            const jobId = document.getElementById('jobIdInput').value.trim();
            if (jobId) {
                currentJobId = jobId;
                loadJobStatus(jobId);
                // Update URL
                const url = new URL(window.location);
                url.searchParams.set('job', jobId);
                window.history.pushState({}, '', url);
            }
        }

        async function loadJobStatus(jobId) {
            try {
                const response = await fetch(`http://localhost:8001/api/v1/jobs/${jobId}`);
                if (response.ok) {
                    const data = await response.json();
                    updateCurrentJobDisplay(data);
                } else {
                    showAlert('Job not found or access denied', 'error');
                    document.getElementById('currentJobSection').style.display = 'none';
                }
            } catch (error) {
                showAlert('Error loading job status: ' + error.message, 'error');
            }
        }

        function updateCurrentJobDisplay(jobData) {
            document.getElementById('currentJobSection').style.display = 'block';
            document.getElementById('currentJobId').textContent = jobData.job_id;
            document.getElementById('currentJobStatus').textContent = jobData.status;
            document.getElementById('currentJobStatus').className = `status-badge ${jobData.status}`;
            document.getElementById('currentJobTime').textContent = formatTime(jobData.created_at);

            // Progress
            const percentage = jobData.progress ? jobData.progress.percentage : 0;
            document.getElementById('currentProgressFill').style.width = `${percentage}%`;
            document.getElementById('currentProgressPercentage').textContent = `${Math.round(percentage)}%`;
            
            // Metrics
            document.getElementById('totalRecords').textContent = jobData.progress?.total_records || '-';
            document.getElementById('processedRecords').textContent = jobData.progress?.processed_records || '-';
            document.getElementById('failedRecords').textContent = jobData.progress?.failed_records || '-';
            document.getElementById('estimatedCompletion').textContent = jobData.estimated_completion ? 
                formatTime(jobData.estimated_completion) : '-';

            // Progress details
            if (jobData.status === 'processing') {
                document.getElementById('currentProgressDetails').textContent = 
                    `${jobData.progress?.processed_records || 0} of ${jobData.progress?.total_records || 0} records`;
                document.getElementById('cancelJobBtn').style.display = 'inline-block';
            } else if (jobData.status === 'completed') {
                document.getElementById('currentProgressDetails').textContent = 'Enrichment completed successfully';
                document.getElementById('downloadCurrentBtn').style.display = 'inline-block';
                document.getElementById('cancelJobBtn').style.display = 'none';
            } else if (jobData.status === 'failed') {
                document.getElementById('currentProgressDetails').textContent = 'Job failed - see error details';
                document.getElementById('errorDetails').style.display = 'block';
                document.getElementById('errorContent').textContent = jobData.error || 'Unknown error occurred';
            }
        }

        async function loadRecentJobs() {
            try {
                const response = await fetch('http://localhost:8001/api/v1/jobs?limit=10');
                if (response.ok) {
                    const jobs = await response.json();
                    displayRecentJobs(jobs);
                }
            } catch (error) {
                document.getElementById('jobsGrid').innerHTML = '<p>Error loading recent jobs</p>';
            }
        }

        function displayRecentJobs(jobs) {
            const grid = document.getElementById('jobsGrid');
            if (jobs.length === 0) {
                grid.innerHTML = '<p>No recent jobs found</p>';
                return;
            }

            grid.innerHTML = jobs.map(job => `
                <div class="job-card small" onclick="loadJobStatus('${job.job_id}')">
                    <div class="job-header">
                        <div class="job-id">${job.job_id.substring(0, 8)}...</div>
                        <div class="status-badge ${job.status}">${job.status}</div>
                    </div>
                    <div class="job-info">
                        <div>Records: ${job.total_records || 0}</div>
                        <div>Created: ${formatTime(job.created_at)}</div>
                    </div>
                </div>
            `).join('');
        }

        async function checkSystemStatus() {
            try {
                const response = await fetch('http://localhost:8001/api/v1/health');
                if (response.ok) {
                    const status = await response.json();
                    updateSystemStatus(status);
                }
            } catch (error) {
                updateSystemStatus({ api: false, workers: false, database: false });
            }
        }

        function updateSystemStatus(status) {
            updateStatusIndicator('apiStatus', 'apiStatusText', status.api !== false, 'Online', 'Offline');
            updateStatusIndicator('workerStatus', 'workerStatusText', status.workers !== false, 'Active', 'Inactive');
            updateStatusIndicator('dbStatus', 'dbStatusText', status.database !== false, 'Connected', 'Disconnected');
        }

        function updateStatusIndicator(iconId, textId, isHealthy, healthyText, unhealthyText) {
            const icon = document.getElementById(iconId);
            const text = document.getElementById(textId);
            
            icon.className = `status-icon ${isHealthy ? 'healthy' : 'unhealthy'}`;
            text.textContent = isHealthy ? healthyText : unhealthyText;
        }

        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            
            if (autoRefreshEnabled) {
                refreshInterval = setInterval(() => {
                    if (currentJobId) {
                        loadJobStatus(currentJobId);
                    }
                    loadRecentJobs();
                    checkSystemStatus();
                }, 5000); // Refresh every 5 seconds
            }
        }

        function toggleAutoRefresh() {
            autoRefreshEnabled = document.getElementById('autoRefresh').checked;
            startAutoRefresh();
        }

        function refreshAllData() {
            if (currentJobId) {
                loadJobStatus(currentJobId);
            }
            loadRecentJobs();
            checkSystemStatus();
        }

        function toggleLogs() {
            const logs = document.getElementById('jobLogs');
            const btn = document.getElementById('viewLogsBtn');
            
            if (logs.style.display === 'none' || !logs.style.display) {
                logs.style.display = 'block';
                btn.textContent = 'Hide Logs';
                loadJobLogs();
            } else {
                logs.style.display = 'none';
                btn.textContent = 'View Logs';
            }
        }

        async function loadJobLogs() {
            if (!currentJobId) return;
            
            try {
                const response = await fetch(`http://localhost:8001/api/v1/jobs/${currentJobId}/logs`);
                if (response.ok) {
                    const logs = await response.json();
                    displayLogs(logs);
                }
            } catch (error) {
                document.getElementById('logContainer').innerHTML = '<div class="log-entry error">Error loading logs</div>';
            }
        }

        function displayLogs(logs) {
            const container = document.getElementById('logContainer');
            if (logs.length === 0) {
                container.innerHTML = '<div class="log-entry">No logs available</div>';
                return;
            }

            container.innerHTML = logs.map(log => `
                <div class="log-entry ${log.level}">
                    <span class="log-time">${formatTime(log.timestamp)}</span>
                    <span class="log-message">${log.message}</span>
                </div>
            `).join('');
        }

        async function downloadCurrentJob() {
            if (!currentJobId) return;
            
            const link = document.createElement('a');
            link.href = `http://localhost:8001/api/v1/jobs/${currentJobId}/download`;
            link.download = `enriched_${currentJobId}.csv`;
            link.click();
        }

        async function cancelCurrentJob() {
            if (!currentJobId) return;
            
            if (confirm('Are you sure you want to cancel this job?')) {
                try {
                    const response = await fetch(`http://localhost:8001/api/v1/jobs/${currentJobId}/cancel`, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        showAlert('Job cancellation requested', 'success');
                        loadJobStatus(currentJobId);
                    } else {
                        showAlert('Failed to cancel job', 'error');
                    }
                } catch (error) {
                    showAlert('Error cancelling job: ' + error.message, 'error');
                }
            }
        }

        function formatTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString();
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alertMessage');
            const alertText = document.getElementById('alertText');
            const alertIcon = document.getElementById('alertIcon');
            
            alertText.textContent = message;
            alert.className = `alert ${type}`;
            alert.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>

    <script src="../app/static/app.js"></script>
</body>
</html>