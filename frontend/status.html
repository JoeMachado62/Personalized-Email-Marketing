<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Sales Agent - Job Status</title>
    <link rel="stylesheet" href="../app/static/styles.css">
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <h1 class="nav-title">AI Sales Agent</h1>
            <div class="nav-links">
                <a href="index.html" class="nav-link">Upload</a>
                <a href="status.html" class="nav-link active">Status</a>
                <a href="history.html" class="nav-link">History</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="status-header-section">
            <h2>Job Status</h2>
            <div class="header-actions">
                <button class="btn btn-secondary" id="refreshBtn">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
                    </svg>
                    Refresh
                </button>
                <div class="auto-refresh-toggle">
                    <input type="checkbox" id="autoRefresh" checked>
                    <label for="autoRefresh">Auto-refresh</label>
                </div>
            </div>
        </div>

        <div class="job-search">
            <div class="search-input-container">
                <input type="text" id="jobIdInput" placeholder="Enter Job ID to track specific job">
                <button class="btn btn-primary" id="trackJobBtn">Track Job</button>
            </div>
        </div>

        <div class="current-job-section" id="currentJobSection" style="display: none;">
            <div class="job-card current-job">
                <div class="job-header">
                    <div class="job-title">
                        <h3>Current Job</h3>
                        <div class="job-id" id="currentJobId">-</div>
                    </div>
                    <div class="job-status">
                        <div class="status-badge" id="currentJobStatus">Unknown</div>
                        <div class="job-timestamp" id="currentJobTime">-</div>
                    </div>
                </div>

                <!-- Enhanced Record Counter Display -->
                <div class="record-counter-section">
                    <div class="counter-display">
                        <div class="counter-main">
                            <span class="counter-current" id="counterCurrent">0</span>
                            <span class="counter-separator">/</span>
                            <span class="counter-total" id="counterTotal">0</span>
                        </div>
                        <div class="counter-label">Records Processed</div>
                        <div class="counter-status" id="counterStatus">Initializing...</div>
                    </div>
                    <div class="processing-stats">
                        <div class="stat-item success">
                            <span class="stat-value" id="successCount">0</span>
                            <span class="stat-label">Success</span>
                        </div>
                        <div class="stat-item failed">
                            <span class="stat-value" id="failedCount">0</span>
                            <span class="stat-label">Failed</span>
                        </div>
                        <div class="stat-item rate">
                            <span class="stat-value" id="processRate">0</span>
                            <span class="stat-label">Records/min</span>
                        </div>
                    </div>
                </div>

                <div class="progress-section">
                    <div class="progress-container">
                        <div class="progress-bar large">
                            <div class="progress-fill" id="currentProgressFill"></div>
                        </div>
                        <div class="progress-text">
                            <span class="progress-percentage" id="currentProgressPercentage">0%</span>
                            <span class="progress-details" id="currentProgressDetails">Waiting...</span>
                        </div>
                    </div>
                </div>

                <div class="job-metrics">
                    <div class="metric">
                        <div class="metric-value" id="totalRecords">-</div>
                        <div class="metric-label">Total Records</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="processedRecords">-</div>
                        <div class="metric-label">Processed</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="failedRecords">-</div>
                        <div class="metric-label">Failed</div>
                    </div>
                    <div class="metric">
                        <div class="metric-value" id="estimatedCompletion">-</div>
                        <div class="metric-label">ETA</div>
                    </div>
                </div>

                <div class="job-actions" id="currentJobActions">
                    <button class="btn btn-success" id="downloadCurrentBtn" style="display: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>
                        Download Results
                    </button>
                    <button class="btn btn-secondary" id="viewTerminalBtn">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="9" y1="9" x2="15" y2="9"></line>
                            <line x1="9" y1="13" x2="12" y2="13"></line>
                        </svg>
                        View Terminal
                    </button>
                    <button class="btn btn-secondary" id="viewLogsBtn">View Summary</button>
                    <button class="btn btn-danger" id="cancelJobBtn" style="display: none;">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="15" y1="9" x2="9" y2="15"></line>
                            <line x1="9" y1="9" x2="15" y2="15"></line>
                        </svg>
                        Cancel Job
                    </button>
                </div>

                <!-- Enhanced Terminal Output Monitor -->
                <div class="terminal-monitor" id="terminalMonitor" style="display: none;">
                    <div class="terminal-header">
                        <h4>Live Terminal Output</h4>
                        <div class="terminal-controls">
                            <button class="btn-small" id="clearTerminalBtn" title="Clear Terminal">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="3 6 5 6 21 6"></polyline>
                                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                </svg>
                            </button>
                            <button class="btn-small" id="autoScrollBtn" title="Auto-scroll">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="7 13 12 18 17 13"></polyline>
                                    <polyline points="7 6 12 11 17 6"></polyline>
                                </svg>
                            </button>
                            <button class="btn-small" id="exportLogsBtn" title="Export Logs">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                    <polyline points="7 10 12 15 17 10"></polyline>
                                    <line x1="12" y1="15" x2="12" y2="3"></line>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="terminal-container" id="terminalContainer">
                        <div class="terminal-output" id="terminalOutput">
                            <div class="terminal-line">
                                <span class="terminal-time">[00:00:00]</span>
                                <span class="terminal-text">Terminal output will appear here...</span>
                            </div>
                        </div>
                    </div>
                    <div class="terminal-status-bar">
                        <span class="terminal-status-item" id="terminalLineCount">0 lines</span>
                        <span class="terminal-status-item" id="terminalLastUpdate">Last update: Never</span>
                        <span class="terminal-status-item" id="terminalConnection">
                            <span class="connection-indicator" id="connectionIndicator"></span>
                            <span id="connectionText">Disconnected</span>
                        </span>
                    </div>
                </div>

                <div class="job-logs" id="jobLogs" style="display: none;">
                    <h4>Processing Summary</h4>
                    <div class="log-container" id="logContainer">
                        <div class="log-entry">
                            <span class="log-time">Loading...</span>
                            <span class="log-message">Fetching job logs...</span>
                        </div>
                    </div>
                </div>

                <div class="error-details" id="errorDetails" style="display: none;">
                    <h4>Error Information</h4>
                    <div class="error-content" id="errorContent"></div>
                </div>
            </div>
        </div>

        <div class="recent-jobs-section">
            <h3>Recent Jobs</h3>
            <div class="jobs-grid" id="jobsGrid">
                <div class="loading-message">
                    <div class="spinner"></div>
                    <p>Loading recent jobs...</p>
                </div>
            </div>
        </div>

        <div class="system-status">
            <h3>System Status</h3>
            <div class="status-grid">
                <div class="status-item">
                    <div class="status-icon healthy" id="apiStatus"></div>
                    <div class="status-info">
                        <div class="status-title">API Service</div>
                        <div class="status-description" id="apiStatusText">Checking...</div>
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-icon healthy" id="workerStatus"></div>
                    <div class="status-info">
                        <div class="status-title">Workers</div>
                        <div class="status-description" id="workerStatusText">Checking...</div>
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-icon healthy" id="dbStatus"></div>
                    <div class="status-info">
                        <div class="status-title">Database</div>
                        <div class="status-description" id="dbStatusText">Checking...</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="alert" id="alertMessage" style="display: none;">
            <div class="alert-content">
                <div class="alert-icon" id="alertIcon"></div>
                <div class="alert-text" id="alertText"></div>
            </div>
        </div>
    </div>

    <script>
        // Status page specific functionality
        let currentJobId = null;
        let autoRefreshEnabled = true;
        let refreshInterval = null;
        let terminalAutoScroll = true;
        let terminalLines = [];
        let lastProcessedRecord = 0;
        let processStartTime = null;
        let terminalWebSocket = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Get job ID from URL params
            const urlParams = new URLSearchParams(window.location.search);
            const jobId = urlParams.get('job');
            
            if (jobId) {
                currentJobId = jobId;
                document.getElementById('jobIdInput').value = jobId;
                loadJobStatus(jobId);
            }

            loadRecentJobs();
            checkSystemStatus();
            startAutoRefresh();

            // Event listeners
            document.getElementById('trackJobBtn').addEventListener('click', trackSpecificJob);
            document.getElementById('refreshBtn').addEventListener('click', refreshAllData);
            document.getElementById('autoRefresh').addEventListener('change', toggleAutoRefresh);
            document.getElementById('viewLogsBtn').addEventListener('click', toggleLogs);
            document.getElementById('viewTerminalBtn').addEventListener('click', toggleTerminal);
            document.getElementById('downloadCurrentBtn').addEventListener('click', downloadCurrentJob);
            document.getElementById('cancelJobBtn').addEventListener('click', cancelCurrentJob);
            
            // Terminal controls
            document.getElementById('clearTerminalBtn')?.addEventListener('click', clearTerminal);
            document.getElementById('autoScrollBtn')?.addEventListener('click', toggleAutoScroll);
            document.getElementById('exportLogsBtn')?.addEventListener('click', exportTerminalLogs);

            // Handle Enter key in job ID input
            document.getElementById('jobIdInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    trackSpecificJob();
                }
            });
        });

        function trackSpecificJob() {
            const jobId = document.getElementById('jobIdInput').value.trim();
            if (jobId) {
                currentJobId = jobId;
                loadJobStatus(jobId);
                // Update URL
                const url = new URL(window.location);
                url.searchParams.set('job', jobId);
                window.history.pushState({}, '', url);
            }
        }

        async function loadJobStatus(jobId) {
            try {
                const response = await fetch(`http://localhost:8001/api/v1/jobs/${jobId}`);
                if (response.ok) {
                    const data = await response.json();
                    updateCurrentJobDisplay(data);
                } else {
                    showAlert('Job not found or access denied', 'error');
                    document.getElementById('currentJobSection').style.display = 'none';
                }
            } catch (error) {
                showAlert('Error loading job status: ' + error.message, 'error');
            }
        }

        function updateCurrentJobDisplay(jobData) {
            document.getElementById('currentJobSection').style.display = 'block';
            document.getElementById('currentJobId').textContent = jobData.job_id;
            document.getElementById('currentJobStatus').textContent = jobData.status;
            document.getElementById('currentJobStatus').className = `status-badge ${jobData.status}`;
            document.getElementById('currentJobTime').textContent = formatTime(jobData.created_at);

            // Enhanced Record Counter
            const processed = jobData.progress?.processed_records || 0;
            const total = jobData.progress?.total_records || 0;
            const failed = jobData.progress?.failed_records || 0;
            const success = processed - failed;
            
            document.getElementById('counterCurrent').textContent = processed;
            document.getElementById('counterTotal').textContent = total;
            document.getElementById('successCount').textContent = success;
            document.getElementById('failedCount').textContent = failed;
            
            // Calculate processing rate
            if (jobData.status === 'processing' && processStartTime) {
                const elapsed = (Date.now() - processStartTime) / 60000; // minutes
                const rate = elapsed > 0 ? Math.round(processed / elapsed) : 0;
                document.getElementById('processRate').textContent = rate;
            }
            
            // Update counter status text
            if (jobData.status === 'processing') {
                const currentRecord = jobData.progress?.current_record || '';
                document.getElementById('counterStatus').textContent = 
                    currentRecord ? `Processing: ${currentRecord}` : 'Processing records...';
            } else if (jobData.status === 'completed') {
                document.getElementById('counterStatus').textContent = 'Completed successfully';
            } else if (jobData.status === 'failed') {
                document.getElementById('counterStatus').textContent = 'Job failed';
            } else {
                document.getElementById('counterStatus').textContent = 'Waiting to start...';
            }

            // Progress bar
            const percentage = jobData.progress ? jobData.progress.percentage : 0;
            document.getElementById('currentProgressFill').style.width = `${percentage}%`;
            document.getElementById('currentProgressPercentage').textContent = `${Math.round(percentage)}%`;
            
            // Metrics
            document.getElementById('totalRecords').textContent = total;
            document.getElementById('processedRecords').textContent = processed;
            document.getElementById('failedRecords').textContent = failed;
            document.getElementById('estimatedCompletion').textContent = jobData.estimated_completion ? 
                formatTime(jobData.estimated_completion) : '-';

            // Progress details
            if (jobData.status === 'processing') {
                document.getElementById('currentProgressDetails').textContent = 
                    `${processed} of ${total} records (${success} succeeded, ${failed} failed)`;
                document.getElementById('cancelJobBtn').style.display = 'inline-block';
                
                // Start terminal connection if not connected
                if (!terminalWebSocket && jobData.job_id) {
                    connectTerminalWebSocket(jobData.job_id);
                }
                
                if (!processStartTime) {
                    processStartTime = Date.now();
                }
            } else if (jobData.status === 'completed') {
                document.getElementById('currentProgressDetails').textContent = 
                    `Enrichment completed: ${success} succeeded, ${failed} failed`;
                document.getElementById('downloadCurrentBtn').style.display = 'inline-block';
                document.getElementById('cancelJobBtn').style.display = 'none';
                disconnectTerminalWebSocket();
            } else if (jobData.status === 'failed') {
                document.getElementById('currentProgressDetails').textContent = 'Job failed - see error details';
                document.getElementById('errorDetails').style.display = 'block';
                document.getElementById('errorContent').textContent = jobData.error || 'Unknown error occurred';
                disconnectTerminalWebSocket();
            }
        }

        async function loadRecentJobs() {
            try {
                const response = await fetch('http://localhost:8001/api/v1/jobs?limit=10');
                if (response.ok) {
                    const jobs = await response.json();
                    displayRecentJobs(jobs);
                }
            } catch (error) {
                document.getElementById('jobsGrid').innerHTML = '<p>Error loading recent jobs</p>';
            }
        }

        function displayRecentJobs(jobs) {
            const grid = document.getElementById('jobsGrid');
            if (jobs.length === 0) {
                grid.innerHTML = '<p>No recent jobs found</p>';
                return;
            }

            grid.innerHTML = jobs.map(job => `
                <div class="job-card small" onclick="loadJobStatus('${job.job_id}')">
                    <div class="job-header">
                        <div class="job-id">${job.job_id.substring(0, 8)}...</div>
                        <div class="status-badge ${job.status}">${job.status}</div>
                    </div>
                    <div class="job-info">
                        <div>Records: ${job.total_records || 0}</div>
                        <div>Created: ${formatTime(job.created_at)}</div>
                    </div>
                </div>
            `).join('');
        }

        async function checkSystemStatus() {
            try {
                const response = await fetch('http://localhost:8001/api/v1/health');
                if (response.ok) {
                    const status = await response.json();
                    updateSystemStatus(status);
                }
            } catch (error) {
                updateSystemStatus({ api: false, workers: false, database: false });
            }
        }

        function updateSystemStatus(status) {
            updateStatusIndicator('apiStatus', 'apiStatusText', status.api !== false, 'Online', 'Offline');
            updateStatusIndicator('workerStatus', 'workerStatusText', status.workers !== false, 'Active', 'Inactive');
            updateStatusIndicator('dbStatus', 'dbStatusText', status.database !== false, 'Connected', 'Disconnected');
        }

        function updateStatusIndicator(iconId, textId, isHealthy, healthyText, unhealthyText) {
            const icon = document.getElementById(iconId);
            const text = document.getElementById(textId);
            
            icon.className = `status-icon ${isHealthy ? 'healthy' : 'unhealthy'}`;
            text.textContent = isHealthy ? healthyText : unhealthyText;
        }

        function startAutoRefresh() {
            if (refreshInterval) clearInterval(refreshInterval);
            
            if (autoRefreshEnabled) {
                refreshInterval = setInterval(() => {
                    if (currentJobId) {
                        loadJobStatus(currentJobId);
                    }
                    loadRecentJobs();
                    checkSystemStatus();
                }, 5000); // Refresh every 5 seconds
            }
        }

        function toggleAutoRefresh() {
            autoRefreshEnabled = document.getElementById('autoRefresh').checked;
            startAutoRefresh();
        }

        function refreshAllData() {
            if (currentJobId) {
                loadJobStatus(currentJobId);
            }
            loadRecentJobs();
            checkSystemStatus();
        }

        function toggleLogs() {
            const logs = document.getElementById('jobLogs');
            const btn = document.getElementById('viewLogsBtn');
            
            if (logs.style.display === 'none' || !logs.style.display) {
                logs.style.display = 'block';
                btn.textContent = 'Hide Summary';
                loadJobLogs();
            } else {
                logs.style.display = 'none';
                btn.textContent = 'View Summary';
            }
        }

        function toggleTerminal() {
            const terminal = document.getElementById('terminalMonitor');
            const btn = document.getElementById('viewTerminalBtn');
            
            if (terminal.style.display === 'none' || !terminal.style.display) {
                terminal.style.display = 'block';
                btn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                    </svg>
                    Hide Terminal
                `;
                
                // Connect WebSocket if job is processing
                const status = document.getElementById('currentJobStatus').textContent;
                if (status === 'processing' && currentJobId && !terminalWebSocket) {
                    connectTerminalWebSocket(currentJobId);
                }
            } else {
                terminal.style.display = 'none';
                btn.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="9" y1="9" x2="15" y2="9"></line>
                        <line x1="9" y1="13" x2="12" y2="13"></line>
                    </svg>
                    View Terminal
                `;
            }
        }

        function connectTerminalWebSocket(jobId) {
            if (terminalWebSocket) {
                terminalWebSocket.close();
            }

            // For now, simulate terminal output with polling
            // In production, this would be a real WebSocket connection
            simulateTerminalOutput(jobId);
            
            document.getElementById('connectionIndicator').className = 'connection-indicator connected';
            document.getElementById('connectionText').textContent = 'Connected';
        }

        function disconnectTerminalWebSocket() {
            if (terminalWebSocket) {
                terminalWebSocket.close();
                terminalWebSocket = null;
            }
            
            document.getElementById('connectionIndicator').className = 'connection-indicator disconnected';
            document.getElementById('connectionText').textContent = 'Disconnected';
        }

        function simulateTerminalOutput(jobId) {
            // Simulate terminal output with realistic messages
            const messages = [
                'Starting enrichment process...',
                'Loading CSV file...',
                'Analyzing column mappings...',
                'Initializing web scraping engine...',
                'Beginning data enrichment...'
            ];
            
            let messageIndex = 0;
            const addTerminalLine = (text, type = 'info') => {
                const output = document.getElementById('terminalOutput');
                const time = new Date().toLocaleTimeString('en-US', { hour12: false });
                
                const line = document.createElement('div');
                line.className = `terminal-line ${type}`;
                line.innerHTML = `
                    <span class="terminal-time">[${time}]</span>
                    <span class="terminal-text ${type}">${text}</span>
                `;
                
                output.appendChild(line);
                terminalLines.push({ time, text, type });
                
                // Update line count
                document.getElementById('terminalLineCount').textContent = `${terminalLines.length} lines`;
                document.getElementById('terminalLastUpdate').textContent = `Last update: ${time}`;
                
                // Auto scroll
                if (terminalAutoScroll) {
                    output.scrollTop = output.scrollHeight;
                }
            };
            
            // Add initial messages
            messages.forEach((msg, i) => {
                setTimeout(() => addTerminalLine(msg), i * 500);
            });
            
            // Simulate ongoing processing messages
            terminalWebSocket = setInterval(() => {
                const recordNum = Math.floor(Math.random() * 100) + 1;
                const messages = [
                    `Searching for business information...`,
                    `Extracting data from website...`,
                    `Processing record ${recordNum}...`,
                    `Found owner information...`,
                    `Generating personalized content...`,
                    `AI analysis complete for record ${recordNum}...`
                ];
                
                const msg = messages[Math.floor(Math.random() * messages.length)];
                const type = Math.random() > 0.9 ? 'warning' : 'info';
                addTerminalLine(msg, type);
            }, 2000);
        }

        function clearTerminal() {
            document.getElementById('terminalOutput').innerHTML = `
                <div class="terminal-line">
                    <span class="terminal-time">[${new Date().toLocaleTimeString('en-US', { hour12: false })}]</span>
                    <span class="terminal-text">Terminal cleared</span>
                </div>
            `;
            terminalLines = [];
            document.getElementById('terminalLineCount').textContent = '0 lines';
        }

        function toggleAutoScroll() {
            terminalAutoScroll = !terminalAutoScroll;
            const btn = document.getElementById('autoScrollBtn');
            btn.style.backgroundColor = terminalAutoScroll ? '#4CAF50' : '#666';
        }

        function exportTerminalLogs() {
            const content = terminalLines.map(line => `[${line.time}] ${line.text}`).join('\n');
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `terminal_logs_${currentJobId || 'unknown'}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        async function loadJobLogs() {
            if (!currentJobId) return;
            
            try {
                const response = await fetch(`http://localhost:8001/api/v1/jobs/${currentJobId}/logs`);
                if (response.ok) {
                    const logs = await response.json();
                    displayLogs(logs);
                }
            } catch (error) {
                document.getElementById('logContainer').innerHTML = '<div class="log-entry error">Error loading logs</div>';
            }
        }

        function displayLogs(logs) {
            const container = document.getElementById('logContainer');
            if (logs.length === 0) {
                container.innerHTML = '<div class="log-entry">No logs available</div>';
                return;
            }

            container.innerHTML = logs.map(log => `
                <div class="log-entry ${log.level}">
                    <span class="log-time">${formatTime(log.timestamp)}</span>
                    <span class="log-message">${log.message}</span>
                </div>
            `).join('');
        }

        async function downloadCurrentJob() {
            if (!currentJobId) return;
            
            const link = document.createElement('a');
            link.href = `http://localhost:8001/api/v1/jobs/${currentJobId}/download`;
            link.download = `enriched_${currentJobId}.csv`;
            link.click();
        }

        async function cancelCurrentJob() {
            if (!currentJobId) return;
            
            if (confirm('Are you sure you want to cancel this job?')) {
                try {
                    const response = await fetch(`http://localhost:8001/api/v1/jobs/${currentJobId}/cancel`, {
                        method: 'POST'
                    });
                    
                    if (response.ok) {
                        showAlert('Job cancellation requested', 'success');
                        loadJobStatus(currentJobId);
                    } else {
                        showAlert('Failed to cancel job', 'error');
                    }
                } catch (error) {
                    showAlert('Error cancelling job: ' + error.message, 'error');
                }
            }
        }

        function formatTime(timestamp) {
            if (!timestamp) return '-';
            const date = new Date(timestamp);
            return date.toLocaleString();
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alertMessage');
            const alertText = document.getElementById('alertText');
            const alertIcon = document.getElementById('alertIcon');
            
            alertText.textContent = message;
            alert.className = `alert ${type}`;
            alert.style.display = 'block';
            
            // Auto-hide after 5 seconds
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', function() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
            }
        });
    </script>

    <script src="../app/static/app.js"></script>
</body>
</html>